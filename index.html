<script>
    const version_date = `
    last modified: 2024/07/07 11:50:59
    `;
    // version_dateからlast modified, 改行と空白を削除
    const version_date_trim = version_date.replace(/last modified: |[\n ]/g, '');


</script>
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <title>ウェブカメラ切り替えと設定</title>
</head>

<body>
    <div class="container-sm">

        <h1 class="mt-5 display-1">Webcam.hack</h1>
        <p class="text-muted small"><span id="version_date"></span></p>
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Camera Serrings
                    </div>
                    <div class="card-body">
                        <div class="input-group mb-3">
                            <button class="btn btn-outline-primary" id="init-button">Get device list</button>
                            <select class="form-select" id="camera-select"></select>
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="inputGroup-sizing-sm">Resolution</span>
                            <select class="form-select" id="resolution-select">
                                <option value="default">default</option>
                                <option value="320x240">320x240</option>
                                <option value="640x480">640x480</option>
                                <option value="1280x720">1280x720</option>
                                <option value="1920x1080">1920x1080</option>
                                <option value="2560x1440">2560x1440</option>
                                <option value="3840x2160">3840x2160</option>
                            </select>
                            <span class="input-group-text" id="inputGroup-sizing-sm">FPS</span>
                            <select class="form-select" id="frame-rate-select">
                                <option value="default">default</option>
                                <option value="15">15 fps</option>
                                <option value="30">30 fps</option>
                                <option value="60">60 fps</option>
                                <option value="120">120 fps</option>
                                <option value="240">240 fps</option>
                            </select>
                        </div>

                        <div class="input-group mb-3">
                            <button class="btn btn-outline-danger" id="start-button">Start Camera</button>
                        </div>

                        <div class="input-group mb-3">
                            <button class="btn btn-outline-danger" id="start-button-with-device_id">
                                Start Camera with Device ID
                            </button>
                            <input class="form-control" type="text" id="device_id" placeholder="Device ID">
                        </div>

                        <div class="input-group mb-3">
                            <button class="btn btn-outline-danger" id="start-button-with-longer-focus-distance">
                                Start Camera with longer focusDistance
                            </button>
                        </div>

                    </div>
                </div>

            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Camera Preview and Info
                    </div>
                    <div class="card-body">
                        <video class="img-fluid" id="video" autoplay playsinline></video>
                        <div class="small alert alert-light" id="camera-info"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script>
        document.getElementById('version_date').innerText = version_date_trim;
        const videoElement = document.getElementById('video');
        const cameraSelect = document.getElementById('camera-select');
        const resolutionSelect = document.getElementById('resolution-select');
        const frameRateSelect = document.getElementById('frame-rate-select');
        const startButton = document.getElementById('start-button');
        const startButtonWithDeviceId = document.getElementById('start-button-with-device_id');
        const startButtonWithLongerFocusDistance = document.getElementById('start-button-with-longer-focus-distance');
        const initButton = document.getElementById('init-button');
        const cameraInfo = document.getElementById('camera-info');
        let initialStream;

        initButton.addEventListener('click', async () => {
            try {
                // 仮のカメラアクセスをリクエストしてユーザーの許可を取得
                initialStream = await navigator.mediaDevices.getUserMedia({ video: true });
                // デバイス一覧を取得
                await listCameras();
                // ストリームを停止してカメラをクローズ
                if (initialStream) {
                    initialStream.getTracks().forEach(track => track.stop());
                }
            } catch (err) {
                console.error('Error accessing media devices.', err);
            }
        });

        startButton.addEventListener('click', () => {
            const selectedDeviceId = cameraSelect.value;
            const selectedResolution = resolutionSelect.value;
            const selectedFrameRate = frameRateSelect.value;
            const [width, height] = selectedResolution === 'default' ? [null, null] : selectedResolution.split('x').map(Number);
            const frameRate = selectedFrameRate === 'default' ? null : Number(selectedFrameRate);
            startVideo(selectedDeviceId, width, height, frameRate);
        });

        startButtonWithDeviceId.addEventListener('click', () => {
            const deviceId = document.getElementById('device_id').value;
            const selectedResolution = resolutionSelect.value;
            const selectedFrameRate = frameRateSelect.value;
            const [width, height] = selectedResolution === 'default' ? [null, null] : selectedResolution.split('x').map(Number);
            const frameRate = selectedFrameRate === 'default' ? null : Number(selectedFrameRate);
            startVideo(deviceId);
        });

        startButtonWithLongerFocusDistance.addEventListener('click', () => {
            const deviceId = document.getElementById('device_id').value;
            const selectedResolution = resolutionSelect.value;
            const selectedFrameRate = frameRateSelect.value;
            const [width, height] = selectedResolution === 'default' ? [null, null] : selectedResolution.split('x').map(Number);
            const frameRate = selectedFrameRate === 'default' ? null : Number(selectedFrameRate);
            startVideo();
        });

        async function listCameras() {
            try {
                // デバイスを列挙
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoInputs = devices.filter(device => device.kind === 'videoinput');

                // セレクトボックスをクリア
                cameraSelect.innerHTML = '';

                // カメラデバイスをセレクトボックスに追加
                videoInputs.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `カメラ ${index + 1} `;
                    cameraSelect.appendChild(option);
                });
            } catch (err) {
                console.error('Error accessing media devices.', err);
            }
        }

        async function stopVideo() {
            if (window.currentStream) {
                window.currentStream.getTracks().forEach(track => track.stop());
            }
        }
        async function startVideo(deviceId, width, height, frameRate) {
            if (window.currentStream) {
                // 現在のストリームを停止
                window.currentStream.getTracks().forEach(track => track.stop());
            }

            try {
                let constraints = {

                };
                if (deviceId) {
                    constraints.video = { deviceId: { exact: deviceId } };
                } else {
                    constraints.video = {};
                }
                if (width && height) {
                    constraints.video.width = { exact: width };
                    constraints.video.height = { exact: height };
                }
                if (frameRate) {
                    constraints.video.frameRate = { exact: frameRate };
                }
                constraints.focusDistance = { ideal: 0.6 };
                constraints.video.zoom = { ideal: 2 };
                constraints.focusMode = 'manual';
                constraints.video.facingMode = 'environment';
                console.log(constraints);

                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = stream;
                window.currentStream = stream;

                // 解像度などの詳細情報を取得して表示
                const videoTrack = stream.getVideoTracks()[0];
                const settings = videoTrack.getSettings();
                displayCameraInfo(settings);
                const capabilities = videoTrack.getCapabilities();
                displayCapabilities(capabilities);
            } catch (err) {
                console.error('Error accessing the camera.', err);
                stopVideo();
                alert(err);
            }
        }

        function displayCameraInfo(settings) {
            console.log(settings);
            cameraInfo.innerHTML = `
                <br><strong>Video Settings:</strong><br>
                ${JSON.stringify(settings, null, 2)}
            `;
            cameraInfo.style.display = 'block';
        }

        function displayCapabilities(capabilities) {
            cameraInfo.innerHTML += `
                <br><strong>Capabilities:</strong><br>
                ${JSON.stringify(capabilities, null, 2)}
            `;
            cameraInfo.style.display = 'block';
        }

        // ページ読み込み時にカメラデバイスの一覧を取得
        document.addEventListener('DOMContentLoaded', listCameras);
    </script>
</body>

</html>